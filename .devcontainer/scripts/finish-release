#!/bin/bash

# --- Initialisation ---
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
DRY_RUN=false
FINAL_TAG=""

# --- Analyse des arguments ---
for arg in "$@"; do
  case $arg in
    --dry-run)
      DRY_RUN=true
      ;;
    -h|--help)
      echo "â„¹ï¸  Usage: finish-release [--dry-run] <final-version>"
      echo "  Must be run from a 'release/X.x' branch"
      echo "  Example: finish-release 9.0"
      exit 0
      ;;
    *)
      FINAL_TAG=$arg
      ;;
  esac
done

# --- VÃ©rifications de base ---
if [[ -z "$FINAL_TAG" ]]; then
  echo "âŒ Missing final version tag. Usage: finish-release <X.Y>"
  exit 1
fi

if [[ ! "$CURRENT_BRANCH" =~ ^release\/[0-9]+\.x$ ]]; then
  echo "âŒ You must be on a 'release/X.x' branch to finish a release."
  exit 1
fi

if ! [[ "$FINAL_TAG" =~ ^[0-9]+\.[0-9]+$ ]]; then
  echo "âŒ Invalid version format '$FINAL_TAG'. Expected format: X.Y"
  exit 1
fi

# --- VÃ©rifie que le dÃ©pÃ´t est valide ---
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  echo "âŒ Not a valid Git repository."
  exit 1
fi

# --- Mode dry-run ---
if $DRY_RUN; then
  echo "ğŸ§ª [DRY-RUN] Would merge '$CURRENT_BRANCH' into 'master'"
  echo "ğŸ§ª [DRY-RUN] Would tag: $FINAL_TAG on master"
  echo "ğŸ§ª [DRY-RUN] Would merge '$CURRENT_BRANCH' into 'develop'"
  echo "ğŸ§ª [DRY-RUN] Would delete branch '$CURRENT_BRANCH'"
  exit 0
fi

# --- Fusion dans master ---
echo "ğŸ” Checking out 'master'..."
git checkout master || exit 1

echo "ğŸ”€ Merging '$CURRENT_BRANCH' into 'master'..."
HUSKY=0 git merge --no-ff "$CURRENT_BRANCH" -m "ğŸ”€ Final merge of $CURRENT_BRANCH into master" || exit 1

echo "ğŸ·ï¸  Tagging 'master' with '$FINAL_TAG'..."
HUSKY=0 git tag -a "$FINAL_TAG" -m "Release $FINAL_TAG"

# --- Fusion dans develop ---
echo "ğŸ” Checking out 'develop'..."
git checkout develop || exit 1

echo "ğŸ”€ Merging '$CURRENT_BRANCH' into 'develop'..."
HUSKY=0 git merge --no-ff "$CURRENT_BRANCH" -m "ğŸ”€ Merge $CURRENT_BRANCH into develop (post-release)" || exit 1

# --- Push branches et tag ---
echo "ğŸš€ Pushing 'master', 'develop' and tag '$FINAL_TAG' to origin..."
HUSKY=0 git push origin master develop || exit 1
HUSKY=0 git push origin "$FINAL_TAG" || exit 1

# --- Suppression de la branche locale ---
echo "ğŸ§¹ Deleting local branch '$CURRENT_BRANCH'..."
git branch -d "$CURRENT_BRANCH" || echo "âš ï¸  Could not delete local branch."

# --- Suppression de la branche distante ---
echo "ğŸ§¹ Deleting remote branch '$CURRENT_BRANCH'..."
git push origin --delete "$CURRENT_BRANCH" || echo "âš ï¸  Could not delete remote branch."

# --- RÃ©sumÃ© final ---
echo "ğŸ‰ Release '$FINAL_TAG' successfully completed!"
echo "   - Merged into master and develop"
echo "   - Tagged on master: $FINAL_TAG"
